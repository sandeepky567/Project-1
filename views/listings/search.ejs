<% layout('layouts/boilerplate') -%>

<h3 class="mt-3">Search results for "<%= query %>"</h3>

<style>
  /* Fav heart styling copied from index.ejs so size/appearance match */
  .fav-heart {
    color: #ff3b3b; /* bright red (controls svg fill via currentColor) */
    width: 34px; /* match index size */
    height: 34px;
    display: inline-block;
    padding: 4px;
    border-radius: 8px;
    background: rgba(255,255,255,0.95);
    position: absolute;
    top: 8px;
    right: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }

  .fav-heart svg { width: 100%; height: 100%; display: block; fill: currentColor; }

  .fav-heart { cursor: pointer; transition: transform 0.12s ease, background-color 0.12s ease, color 0.12s ease; }

  .fav-heart.favorited { background: #ff3b3b; color: #fff; transform: scale(1.05); }
  
</style>

<div class="row row-cols-lg-4 row-cols-md-2 row-cols-sm-1 g-5 mt-4">
  <% if(listings && listings.length){ %>
    <% for(let listing of listings) { %>
      <a href="/listings/<%= listing._id %>" class="listing-link" data-id="<%= listing._id %>" data-location="<%= listing.location ? listing.location : '' %>" data-title="<%= listing.title ? listing.title.replace(/"/g,'&quot;') : '' %>" data-desc="<%= listing.description ? listing.description.replace(/"/g,'&quot;') : '' %>">
         <div class="card col listings-card">
    
    <img src="<%= typeof listing.image === 'object' ? listing.image.url : (listing.image || '/images/default.jpg') %>"
     class="card-img-top"
     alt="listing_image"
     style="height: 20rem;">
     
            <div class="card-img-overlay"><span class="fav-heart"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true"><path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/></svg></span></div>
            <div class="card-body">
              <p class="card-text">
               <b><%= listing.title %></b><br>
                <%= listing.description %>
              </p><br>
              <p>&#x20b9;<%= listing.price.toLocaleString("en-IN") %>/night</p>
            </div>
         </div>
      </a>
    <% } %>
  <% } else { %>
    <div class="col-12 mt-4">No listings found for this location.</div>
  <% } %>
</div>

<script>
  // Favorite heart toggle: persist in localStorage and prevent navigation when clicking heart
  (function(){
    const storageKey = 'bmh_favorites';
    const hearts = document.querySelectorAll('.fav-heart');

    function loadFavs(){
      try{ return JSON.parse(localStorage.getItem(storageKey)) || []; }catch(e){ return []; }
    }
    function saveFavs(arr){ localStorage.setItem(storageKey, JSON.stringify(arr)); }

    const favs = new Set(loadFavs());

    hearts.forEach(h => {
      const link = h.closest('.listing-link');
      const id = link && link.dataset && link.dataset.id ? link.dataset.id : (link ? (link.getAttribute('href')||'').split('/').pop() : null);
      if(!id) return;
      if(favs.has(id)) h.classList.add('favorited');

      h.addEventListener('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        if(h.classList.contains('favorited')){
          h.classList.remove('favorited');
          favs.delete(id);
        } else {
          h.classList.add('favorited');
          favs.add(id);
        }
        saveFavs(Array.from(favs));
      });
    });
  })();
</script>
